# 企业数字化平台总体设计蓝图

下述方案将需求拆分为多个可并行交付的域服务，采用“统一入口 + 微服务 + 事件驱动”的体系。每个功能块都给出核心职责、接口/数据要点、并发与资源优化思路，便于后续快速落地。

## 架构总览
- **入口层**：统一登录/门户 + API 网关；支持 OAuth2/OIDC、SAML、企业三方登录；所有流量经 WAF/防火墙和速率限制。
- **服务层**：按业务域拆分 14 个子域（IAM、集成、Office、OA、HRM、财务、供应链、PM、CRM/工单、KM/LMS、移动、EIP、ITSM、BI、低代码）。每个子域内部再细分微服务（例：IAM-Auth、IAM-Org、IAM-RBAC）。
- **数据层**：
  - 事务数据：PostgreSQL/MySQL（分库分表按租户/业务域），读写分离。
  - 缓存：Redis（多租户命名空间，Hot Key 旁路保护）。
  - 消息/任务：Kafka + 延迟队列；关键任务用事务消息或 Outbox 模式。
  - 对象存储：S3 兼容用于文件、附件、录制。
  - 元数据/日志：ELK 或 Loki + Tempo；审计不可篡改链路。
- **并发与资源优化**：
  - 服务使用协程或线程池（Go：goroutine；Java：虚拟线程/Executors；Python：asyncio + uvloop）。
  - 统一限流（令牌桶）、熔断（Circuit Breaker）、Bulkhead 隔离，减少级联故障。
  - 任务类能力走异步（MQ + 定时器），长耗时 I/O 使用异步连接池。
  - 容器化部署 + HPA，根据 QPS/队列积压自动扩缩。

## 关键横切能力
- **鉴权链路**：网关校验 Token/签名 → Auth 服务解码/续期 → 权限服务做 RBAC/ABAC/Data-Scope 判定 → 业务服务鉴权注解/中间件。
- **审计链路**：登录/操作/权限变更/安全事件写入审计流，归档到不可篡改存储，支持追溯与报表。
- **组织主数据**：部门、岗位、职级、上下级关系作为主数据，其他域通过缓存 + 事件订阅保持一致。
- **多租户**：Header/Token 透传租户 ID；数据按租户分库/分表或行级隔离；配置中心隔离租户参数。

## I. IAM（身份与权限）
- **IAM-Account**：账号 CRUD、批量导入、LDAP/AD 同步（定时 + 变更事件）、冻结/解冻；密码策略 & MFA 绑定。
- **IAM-Auth**：SSO（OIDC/SAML）、OAuth2 Provider、MFA（短信/邮件/OTP）、三方登录适配器（钉钉/企微/飞书/AD）。
- **IAM-RBAC/ABAC**：角色、策略、数据/功能权限；资源授权矩阵；接口/菜单/按钮粒度；字段/记录级数据范围。
- **IAM-Org**：部门、岗位、职级、编制，层级/汇报链管理。
- **IAM-Audit**：登录/操作/权限变更审计，风控规则与告警。
- **并发优化**：登录/鉴权走 Redis 缓存 + JWT；策略评估用本地 LRU + 缓存失效广播；批量导入走分段并行 + 幂等。

## II. 数据与系统集成
- **API Gateway**：反向代理、Token 校验、流量控制、路由发布、文档聚合。
- **Token/Key 管理**：签发、轮换、吊销；网关和服务间 mTLS。
- **消息与任务**：Kafka/RabbitMQ，任务调度（Cron + DAG），工作流引擎（BPMN）。
- **ESB**：连接器管理、协议适配、数据转换/路由。
- **数据中心**：数据仓库、元数据、质量校验、同步任务。
- **并发优化**：网关层限流 + 熔断；调度器分片并行；转换任务使用流式处理与背压。

## III. Office 套件
- **文档服务**：在线编辑（协同算法 OT/CRDT）、版本/评论/对比、权限与共享、回收站/标签。
- **IM/会议/邮件**：单群聊、@提醒、文件/多媒体；会议录制与屏幕共享；企业邮箱、签名、日程同步、邮件加密。
- **日程与任务/资源预约**：个人与共享日历、提醒/冲突检测；任务分派/优先级/进度；会议室/车辆/设备/工位预约。
- **并发优化**：协同编辑用 WebSocket + CRDT，增量存储；聊天/会议用房间分区与 SFU；日程冲突检测用分段锁或乐观校验。

## IV. 行政 OA
- **流程审批**：请假/加班/外出/采购/报销/用章/合同，公文起草/流转/印章；流程设计器、条件分支、子流程、加/减签、转办、催办、撤回。
- **信息发布**：公告/新闻/制度库、通知回执、阅读统计。
- **行政管理**：会议、车辆、用品、资产（入库/借用/盘点/报废维修）。
- **并发优化**：BPM 引擎支持并行网关；审批通知异步；全文检索用分片索引。

## V. HRM
- 招聘（需求、流程、面试、简历库、Offer）、员工档案/合同/入转调离、考勤（打卡/排班/异常）、绩效（KPI/OKR/评估/面谈/排名）、薪资（结构、公式、奖金补贴、个税、工资条）。
- **并发优化**：考勤写入走批处理，薪资计算分片并行；人脸/指纹识别用异步回调；绩效评估计算走异步任务。

## VI. 财务（ERP 财务）
- 总账（科目、凭证、结账、报表）、应收应付（客户/供应商、发票、对账）、预算（年度/调整/执行监控）、费用报销（差旅/通用/拍照识别）、固定资产财务（折旧、分录、价值变动）。
- **并发优化**：凭证流水号使用号段/雪花算法；报表生成走异步并缓存；影像识别任务异步；金额计算保持强一致事务。

## VII. 供应链/运营
- 采购（申请/订单/供应商/收货入库/审计）、仓储 WMS（入库/出库/盘点/预警/库区）、销售 CRM（订单/报价/合同/发货/回款）、物流（发运/运单/跟踪）、生产（计划/工单/BOM/报工/质检）。
- **并发优化**：库存扣减用乐观锁 + 重试或分布式锁；BOM/工单计算并行；预警事件异步触发。

## VIII. 项目管理
- 立项/WBS、任务分配、里程碑、甘特图、项目文件、预算/成本、风险/问题跟踪。
- **并发优化**：甘特计算与资源占用检查用批量并行；文件存储走对象存储 + CDN。

## IX. 客户平台（CRM + 工单）
- 客户档案/商机/漏斗/跟进/合同；在线客服、工单、评价、SLA、知识库关联。
- **并发优化**：工单队列按优先级分区；客服会话 WebSocket；SLA 计时器用分布式调度。

## X. 知识与学习
- 知识库（文档/FAQ/标签/搜索）、培训（课程、视频、进度、考试、证书）。
- **并发优化**：搜索用分片索引；视频转码异步；考试判卷任务并发。

## XI. 移动办公 & 企业门户
- 移动审批/打卡/报销/IM/门户；EIP 统一登录入口、待办中心、工作台、信息看板、导航。
- **并发优化**：移动端接口聚合；待办中心使用事件驱动聚合；看板数据走缓存 + 增量推送。

## XII. IT 运维（ITSM）
- IT 工单、资产维修、SLA；CMDB（设备档案、拓扑）；监控（服务器/网络/日志）；软件资产（授权、安装、升级）。
- **并发优化**：监控指标批量写入时使用分片 + 压缩；拓扑计算异步；升级任务分批滚动。

## XIII. 数据分析（BI）
- 大屏、销售/财务/人力/运营看板、自助分析；统一指标口径；数据血缘与权限同步 IAM。
- **并发优化**：预计算 + Cube；查询限流与结果缓存；列式存储。

## XIV. 开发者平台（低代码/扩展）
- 表单/工作流设计器、API 调用平台、插件扩展、自定义报表。
- **并发优化**：表单/流程元数据走缓存；插件沙箱隔离；API 调用平台提供并发/速率保护。

## 交付与治理建议
- 单服务独立仓库或 Monorepo + Bazel；CI/CD 自动化，蓝绿或金丝雀发布。
- 质量与安全：单元/集成/性能测试基线；SAST/DAST；密钥管理与审计闭环。
- Observability：指标、日志、Trace 三合一；SLO/SLI 定义与告警规则。

## 最小可行里程碑（可并行）
1. **M0 基座**：网关、IAM（账号/SSO/MFA/RBAC/审计）、组织主数据、日志链路、消息总线、对象存储。
2. **M1 协同 & OA**：BPM/表单、IM/会议、文档协同、公告与待办中心、移动端壳。
3. **M2 业务域扩展**：HRM + 财务 + 供应链/CRM/PM；数据中心与 BI；低代码与集成平台。

以上蓝图可按域分团队并行实现，每个服务在高并发场景下优先采用协程/线程池与异步事件模型，以降低资源占用并保障稳定性。
